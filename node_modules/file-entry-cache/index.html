<!DOCTYPE html><html lang=""><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="apple-touch-icon" sizes="57x57" href="/assets/favicon/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/assets/favicon/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/assets/favicon/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/assets/favicon/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/assets/favicon/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/assets/favicon/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/assets/favicon/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/assets/favicon/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/assets/favicon/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicon/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png"/><link rel="manifest" href="/assets/favicon/manifest.json"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="/assets/favicon/ms-icon-144x144.png"/><meta name="theme-color" content="#000000"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="apple-mobile-web-app-title" content="inspire korea"/><meta name="twitter:title" content="file-entry-cache"/><meta name="twitter:description" content=""/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@DevYakuza"/><meta name="twitter:creator" content="@DevYakuza"/><title>file-entry-cache - </title><meta name="description" content="책이나 자료를 통해 얻은 영감과 인사이트를 공유하여, 다른 분들도 영감을 얻기를 바랍니다."/><meta property="og:locale" content="ko"/><meta name="author" content="dev.yakuza@gmail.com"/><meta name="og:title" content="file-entry-cache"/><meta name="og:description" content=""/><meta property="og:url" content="https://ink.posstree.com/node_modules/file-entry-cache/"/><meta property="og:site_name" content="file-entry-cache"/><meta property="og:image" content="https://ink.posstree.com"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2025-01-11 17:21:04 +0900"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-125408913-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-125408913-2");</script><script data-ad-client="ca-pub-7987914246691031" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR" rel="stylesheet"/><link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css"/><link rel="stylesheet" href="/assets/vendor/font-awesome/css/font-awesome.min.css"/><link rel="stylesheet" href="/assets/main.css?v=20250112"/><link rel="alternate" type="application/rss+xml" title="[ink] 인스파이어 코리아" href="/feed.xml"/><script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "dev.yakuza",
      "url": "https://ink.posstree.com/",
      "sameAs": [
        "https://www.facebook.com/yakuza.dev.54",
        "https://www.instagram.com/dev_yakuza/",
        "https://twitter.com/DevYakuza"
      ]
    }
  </script><script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://ink.posstree.com/",
      "logo": "https://ink.posstree.com/assets/images/icon.jpg"
    }
  </script><link rel="stylesheet" href="/assets/highlight/railscasts.css"/><script src="/assets/highlight/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script src="/assets//vendor/lazysizes/lazysizes.min.js" async=""></script></head><body><nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav"><div class="container"><a class="navbar-brand" href="/"><img src="/assets/images/icon.png" alt="dev.yakuza blog logo"/> inspire korea </a><div class="navbar-menu-container"><div class="collapse navbar-collapse"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item dropdown"><a class="nav-link" target="_blank" rel="noopener" href="https://dev-yakuza.github.io/ko/">Tech Blog</a></li><li class="nav-item"><a class="nav-link" target="_blank" rel="noopener" href="https://dev-yakuza.github.io/app/list/ko/">Apps</a></li><li class="nav-item"><a class="nav-link" href="/contact/">Contact</a></li></ul></div><button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"> Menu <i class="fa fa-bars"></i></button></div><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item dropdown"><a class="nav-link" target="_blank" rel="noopener" href="https://dev-yakuza.github.io/ko/">Tech Blog</a></li><li class="nav-item"><a class="nav-link" target="_blank" rel="noopener" href="https://dev-yakuza.github.io/app/list/ko/">Apps</a></li><li class="nav-item"><a class="nav-link" href="/contact/">Contact</a></li></ul></div></div></nav><script>document.addEventListener("DOMContentLoaded",function(){var e=window.location.pathname;e.indexOf("/en/")>=0?($(".menu-ko").prop("href",e.replace("/en/","/ko/")),$(".menu-en").prop("href",e),$(".menu-ja").prop("href",e.replace("/en/","/"))):e.indexOf("/ko/")>=0?($(".menu-ko").prop("href",e),$(".menu-en").prop("href",e.replace("/ko/","/en/")),$(".menu-ja").prop("href",e.replace("/ko/","/"))):($(".menu-ko").prop("href","/ko"+e),$(".menu-en").prop("href","/en"+e),$(".menu-ja").prop("href",e)),$("body").on("show.bs.dropdown",".dropdown",function(){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$("body").on("hide.bs.dropdown",".dropdown",function(){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()})});</script><header class="masthead"><div class="overlay"></div><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><div class="page-heading"><h1>file-entry-cache</h1></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><h1 id="file-entry-cache">file-entry-cache</h1><blockquote><p>Super simple cache for file metadata, useful for process that work on a given series of files and that only need to repeat the job on the changed ones since the previous run of the process</p></blockquote><p><a href="https://npmjs.org/package/file-entry-cache"><img src="https://img.shields.io/npm/v/file-entry-cache.svg?style=flat" alt="NPM Version"/></a><a href="https://github.com/jaredwray/file-entry-cache/actions/workflows/tests.yaml"><img src="https://github.com/jaredwray/file-entry-cache/actions/workflows/tests.yaml/badge.svg?branch=master" alt="tests"/></a><a href="https://codecov.io/github/jaredwray/file-entry-cache"><img src="https://codecov.io/github/jaredwray/file-entry-cache/graph/badge.svg?token=37tZMQE0Sy" alt="codecov"/></a><a href="https://npmjs.com/package/file-entry-cache"><img src="https://img.shields.io/npm/dm/file-entry-cache" alt="npm"/></a></p><h2 id="install">install</h2><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i <span class="nt">--save</span> file-entry-cache
</code></pre></div></div><h2 id="usage">Usage</h2><p>The module exposes two functions <code class="language-plaintext highlighter-rouge">create</code> and <code class="language-plaintext highlighter-rouge">createFromFile</code>.</p><h2 id="createcachename-directory-usechecksum-currentworkingdir"><code class="language-plaintext highlighter-rouge">create(cacheName, [directory, useCheckSum, currentWorkingDir])</code></h2><ul><li><strong>cacheName</strong>: the name of the cache to be created</li><li><strong>directory</strong>: Optional the directory to load the cache from</li><li><strong>usecheckSum</strong>: Whether to use md5 checksum to verify if file changed. If false the default will be to use the mtime and size of the file.</li><li><strong>currentWorkingDir</strong>: Optional the current working directory to use when resolving relative paths</li></ul><h2 id="createfromfilepathtocache-usechecksum-currentworkingdir"><code class="language-plaintext highlighter-rouge">createFromFile(pathToCache, [useCheckSum, currentWorkingDir])</code></h2><ul><li><strong>pathToCache</strong>: the path to the cache file (this combines the cache name and directory)</li><li><strong>useCheckSum</strong>: Whether to use md5 checksum to verify if file changed. If false the default will be to use the mtime and size of the file.</li><li><strong>currentWorkingDir</strong>: Optional the current working directory to use when resolving relative paths</li></ul><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// loads the cache, if one does not exists for the given</span>
<span class="c1">// Id a new one will be prepared to be created</span>
<span class="kd">var</span> <span class="nx">fileEntryCache</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">file-entry-cache</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">fileEntryCache</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="dl">'</span><span class="s1">testCache</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">expand</span><span class="p">(</span><span class="dl">'</span><span class="s1">../fixtures/*.txt</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// the first time this method is called, will return all the files</span>
<span class="kd">var</span> <span class="nx">oFiles</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">getUpdatedFiles</span><span class="p">(</span><span class="nx">files</span><span class="p">);</span>

<span class="c1">// this will persist this to disk checking each file stats and</span>
<span class="c1">// updating the meta attributes `size` and `mtime`.</span>
<span class="c1">// custom fields could also be added to the meta object and will be persisted</span>
<span class="c1">// in order to retrieve them later</span>
<span class="nx">cache</span><span class="p">.</span><span class="nx">reconcile</span><span class="p">();</span>

<span class="c1">// use this if you want the non visited file entries to be kept in the cache</span>
<span class="c1">// for more than one execution</span>
<span class="c1">//</span>
<span class="c1">// cache.reconcile( true /* noPrune */)</span>

<span class="c1">// on a second run</span>
<span class="kd">var</span> <span class="nx">cache2</span> <span class="o">=</span> <span class="nx">fileEntryCache</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="dl">'</span><span class="s1">testCache</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// will return now only the files that were modified or none</span>
<span class="c1">// if no files were modified previous to the execution of this function</span>
<span class="kd">var</span> <span class="nx">oFiles</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">getUpdatedFiles</span><span class="p">(</span><span class="nx">files</span><span class="p">);</span>

<span class="c1">// if you want to prevent a file from being considered non modified</span>
<span class="c1">// something useful if a file failed some sort of validation</span>
<span class="c1">// you can then remove the entry from the cache doing</span>
<span class="nx">cache</span><span class="p">.</span><span class="nx">removeEntry</span><span class="p">(</span><span class="dl">'</span><span class="s1">path/to/file</span><span class="dl">'</span><span class="p">);</span> <span class="c1">// path to file should be the same path of the file received on `getUpdatedFiles`</span>
<span class="c1">// that will effectively make the file to appear again as modified until the validation is passed. In that</span>
<span class="c1">// case you should not remove it from the cache</span>

<span class="c1">// if you need all the files, so you can determine what to do with the changed ones</span>
<span class="c1">// you can call</span>
<span class="kd">var</span> <span class="nx">oFiles</span> <span class="o">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">normalizeEntries</span><span class="p">(</span><span class="nx">files</span><span class="p">);</span>

<span class="c1">// oFiles will be an array of objects like the following</span>
<span class="nx">entry</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">some/name/file</span><span class="dl">'</span><span class="p">,</span> <span class="nx">the</span> <span class="nx">path</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">file</span>
  <span class="na">changed</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// if the file was changed since previous run</span>
  <span class="na">meta</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">size</span><span class="p">:</span> <span class="mi">3242</span><span class="p">,</span> <span class="c1">// the size of the file</span>
    <span class="na">mtime</span><span class="p">:</span> <span class="mi">231231231</span><span class="p">,</span> <span class="c1">// the modification time of the file</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{}</span> <span class="c1">// some extra field stored for this file (useful to save the result of a transformation on the file</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div><h2 id="motivation-for-this-module">Motivation for this module</h2><p>I needed a super simple and dumb <strong>in-memory cache</strong> with optional disk persistence (write-back cache) in order to make a script that will beautify files with <code class="language-plaintext highlighter-rouge">esformatter</code> to execute only on the files that were changed since the last run.</p><p>In doing so the process of beautifying files was reduced from several seconds to a small fraction of a second.</p><p>This module uses <a href="https://www.npmjs.com/package/flat-cache">flat-cache</a> a super simple <code class="language-plaintext highlighter-rouge">key/value</code> cache storage with optional file persistance.</p><p>The main idea is to read the files when the task begins, apply the transforms required, and if the process succeed, then store the new state of the files. The next time this module request for <code class="language-plaintext highlighter-rouge">getChangedFiles</code> will return only the files that were modified. Making the process to end faster.</p><p>This module could also be used by processes that modify the files applying a transform, in that case the result of the transform could be stored in the <code class="language-plaintext highlighter-rouge">meta</code> field, of the entries. Anything added to the meta field will be persisted. Those processes won’t need to call <code class="language-plaintext highlighter-rouge">getChangedFiles</code> they will instead call <code class="language-plaintext highlighter-rouge">normalizeEntries</code> that will return the entries with a <code class="language-plaintext highlighter-rouge">changed</code> field that can be used to determine if the file was changed or not. If it was not changed the transformed stored data could be used instead of actually applying the transformation, saving time in case of only a few files changed.</p><p>In the worst case scenario all the files will be processed. In the best case scenario only a few of them will be processed.</p><h2 id="important-notes">Important notes</h2><ul><li>The values set on the meta attribute of the entries should be <code class="language-plaintext highlighter-rouge">stringify-able</code> ones if possible, flat-cache uses <code class="language-plaintext highlighter-rouge">circular-json</code> to try to persist circular structures, but this should be considered experimental. The best results are always obtained with non circular values</li><li>All the changes to the cache state are done to memory first and only persisted after reconcile.</li></ul><h2 id="license">License</h2><p>MIT (c) Jared Wray</p></div></div></div><footer><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto share-title"> SHARE </div><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class="list-inline-item"><a href="https://twitter.com/intent/tweet?text=file-entry-cache&url=https://ink.posstree.com/node_modules/file-entry-cache/" rel="nofollow noreferrer noopener" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span><div style="width: 0; height: 0; overflow: hidden; float: left;"> Twitter </div></a></li><li class="list-inline-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://ink.posstree.com/node_modules/file-entry-cache/" rel="nofollow noreferrer noopener" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-facebook fa-stack-1x fa-inverse"></i></span><div style="width: 0; height: 0; overflow: hidden; float: left;"> Facebook </div></a></li><li class="list-inline-item"><a href="https://ink.posstree.com/feed.xml" rel="nofollow noreferrer noopener" target="_blank"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss-square fa-stack-1x fa-inverse" aria-hidden="true"></i></span><div style="width: 0; height: 0; overflow: hidden; float: left;"> RSS </div></a></li></ul><p class="copyright text-muted"> Copyright &copy; dev.yakuza@gmail.com 2025 </p></div></div></div></footer><script src="/assets/vendor/jquery/jquery.min.js"></script><script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script><script src="/assets/vendor/startbootstrap-clean-blog/js/clean-blog.min.js"></script><script src="/assets/scripts.js?v=20250112"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/railscasts.min.css"></body></html>